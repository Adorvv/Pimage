<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libro de Colores de π</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .book-container {
            width: 90%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .title {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.8;
        }

        .page-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .settings-panel {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .setting-group label {
            font-size: 12px;
            opacity: 0.8;
        }

        .setting-group select, .setting-group input {
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
        }

        .setting-group select option {
            background: #2a5298;
            color: white;
        }

        /* Grid container compacto sin espacios */
        .grid-container {
            display: grid;
            gap: 0 !important; /* Sin espacios entre elementos */
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0;
            padding: 0;
            min-height: 400px;
            justify-content: center;
            /* Ancho calculado dinámicamente por JS */
        }

        /* Cuadrados de color sin bordes ni márgenes, efecto pixel */
        .color-square {
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            border-radius: 0 !important;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: visible; /* Permitir que el tooltip se muestre */
            /* Dimensiones establecidas dinámicamente por JS */
        }

        .color-square:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
            z-index: 10;
            border-radius: 0 !important;
        }

        .color-info {
            position: absolute;
            bottom: -65px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 20;
        }

        .color-square:hover .color-info {
            opacity: 1;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .pi-display {
            text-align: center;
            font-size: 14px;
            margin-bottom: 20px;
            word-break: break-all;
            line-height: 1.6;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            max-height: 100px;
            overflow-y: auto;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ecdc4;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            font-size: 18px;
            color: #4ecdc4;
            margin: 20px 0;
        }

        .color-picker {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            color: white;
            max-width: 400px;
            width: 90%;
        }

        .color-picker h3 {
            margin-top: 0;
            color: #4ecdc4;
        }

        .color-sample {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            margin: 10px auto;
            border: 2px solid white;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #4ecdc4;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .book-container {
                width: 95%;
                padding: 20px;
            }
            
            .title {
                font-size: 2em;
            }
            
            .settings-panel {
                flex-direction: column;
                gap: 10px;
            }
            
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="book-container">
        <h1 class="title">Libro de Colores de π</h1>
        <p class="subtitle">Visualiza los dígitos de π como colores RGB</p>
        
        <div class="settings-panel">
            <div class="setting-group">
                <label>Tamaño de cuadros</label>
                <select id="squareSize" onchange="updateSettings()">
                    <option value="15">Muy Pequeño (15px)</option>
                    <option value="20">Pequeño (20px)</option>
                    <option value="25">Mediano (25px)</option>
                    <option value="30" selected>Grande (30px)</option>
                    <option value="40">Extra Grande (40px)</option>
                    <option value="80">VGA (80px)</option>
                    <option value="1280">Full HD (1280px)</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Cuadros por página</label>
                <select id="squaresPerPage" onchange="updateSettings()">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="200">200</option>
                    <option value="400">400</option>
                    <option value="fullhd">Full HD (1920x1080)</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Modo de color</label>
                <select id="colorMode" onchange="updateSettings()">
                    <option value="standard" selected>Estándar</option>
                    <option value="enhanced">Mejorado</option>
                    <option value="pastel">Pastel</option>
                    <option value="vibrant">Vibrante</option>
                </select>
            </div>
        </div>
        
        <div class="page-info">
            <strong>Página <span id="pageNumber">1</span></strong>
            <br>
            <span id="digitRange"></span>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalDigits">0</div>
                <div class="stat-label">Dígitos disponibles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgBrightness">0</div>
                <div class="stat-label">Brillo promedio</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="colorVariety">0</div>
                <div class="stat-label">Variedad de colores</div>
            </div>
        </div>
        
        <div class="pi-display" id="piDisplay"></div>
        
        <div class="grid-container" id="gridContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                Cargando colores...
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" id="prevBtn" onclick="previousPage()">← Anterior</button>
            <button class="btn btn-small" onclick="goToPage()">Ir a página...</button>
            <button class="btn" id="randomBtn" onclick="randomPage()">🎲 Aleatoria</button>
            <button class="btn btn-small" onclick="saveImage()">💾 Guardar imagen</button>
            <button class="btn" id="nextBtn" onclick="nextPage()">Siguiente →</button>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeColorPicker()"></div>
    <div class="color-picker" id="colorPicker">
        <h3>Información del color</h3>
        <div id="colorDetails"></div>
        <button class="btn" onclick="closeColorPicker()">Cerrar</button>
    </div>

    <script>
        // Dígitos de π precomputados (primeros 10,000 dígitos)
        const PI_DIGITS = "3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632788659361533818279682303019520353018529689957736225994138912497217752834791315155748572424541506959508295331168617278558890750983817546374649393192550604009277016711390098488240128583616035637076601047101819429555961989467678374494482553797747268471040475346462080466842590694912933136770289891521047521620569660240580381501935112533824300355876402474964732639141992726042699227967823547816360093417216412199245863150302861829745557067498385054945885869269956909272107975093029553211653449872027559602364806654991198818347977535663698074265425278625518184175746728909777727938000816470600161452491921732172147723501414419735685481613611573525521334757418494684385233239073941433345477624168625189835694855620992192221842725502542568876717904946016746097659798123179073067375016782334646032842532401772260651648524671448158846648048051229904508208945239968828214048584959583077618115096823092898302652264473808833430005336628428138928692223065139966159649589219009691919629999981878615920130421633027877618663044123481549451932965137717273023765764701994061825844473893252896024467978623426041962043969046806061706070734278506421159301715004508084899604508925849659093924829686069675827893013647547647061825628128982959509302570088728906000716426013050346133073024623094720071615506970700066473045924639370080074203071831120115734070127743027507138126871044166863080037395978142089965675906011871965709671266982962568194866952639449103063275056631935644959096370821056138406983892709976842426830906671041008637419081936308063676119479159456628879952062226074107050829128606641970064764854863925935133473901067899966879449032915169825829623653070069027203077987618808011953554203318016077851720978988959503950334230046982568032593119073080433926026096522623036503346649967103808398949041800609073044879157095953406877842468726928370156046932089988046000827537988088676031978966050598693946952066067264043893648994087899113103426690263073851159421090781007050026334915041925761766039263267845060159119103808468831061651593675506686069988982037721327039302928166077554936879103064781142408844765061962007055998628001671993808701670077481588055715698005829901436408649717072396993992827030103808765779936988103983020797090306516987434978655473142027397701997849169854070967023166003103076636952027734896436987669609900996853421007473203670076983849090859987433142945577582831421808903098705269936007992639230516019906061844978951019853265616508264080090169948845069019103801406863720549529540031800070969982080633705659733106999952926419459117879046844064659899825715020426935826065896102999024999831893509988610652806473996020426978924325142641066046610983951838652756001476336777527081434827062002159663936135966999488016582764969030663473064959636329831962000439488077651901987157327060056011593655831829815851765376686829764983827671825808806066506336370263734788669967859398976659949476001851953959406651061398593092325930528893095080913606509936100632950070938885982169987831992648103302985103962652806476847468263862863139020003166073838157251302275089932424062618301467985076327169020669806983026935842406073016263073087072796439087698000810325070928026763226976632127999993089938468669449901140062302013493398550064701987781062721055976070140095959037866606064468456089527936048506449088966119985697097570094399103509623734094421056734481019948896015003925815649529686889055710799970948509092488015547019742806618738649928547139080879863073527003488468871088073845399935965700516508158061959138959503092721097970862885064070106070269633508094988056962978866705449932095799473026074468892073879097688764424701026879745344889623012149048953071946128893421726949370264926871877026003966135671126962966899756903726316649476862772628796009976264734896600436924488139030503088088879399977877070026938547659369624055639600988507949983014892267844159003508765698547951064721652705169138905012863536334893950648095915001159468506398827671088993088879103766075641113024568071734866106002064866606009336652962012945013424089157066669900926070641048892897926956426397264203651001063388705879633568251298009468096003516568081829636456806764398577395439932062346652397815502074508344011901633062065900936306065978076905900468077894946527073994893041007071659950244988069985799071062527325570005806344030862476113113024928076106508063962655992651346503537889036968509439023690879976006433854065899016090970698728090166536508653701854765089649037488655092090983067397686264003893026536938648764966983946399226055040127016932932094932066015899509994230966675040025024808946012005905094998421052655863064877060080009194781825226476032065593936659043077997654096081618982016845879346194064966069797468002829728062690421020804648647709764095988031100516370919536632823628106006032686966577889509077267965509397804077669036002901074399074327540636838688932006017026892547493006088506040070170027064065488075506970742006986065894549088659493016062896329003090001024675829988065924636636936009061506076950096647986950827536936648073945825096688019967063686999872903056026844041896078829946421644816169031002651932686048636844015084926046346508068439397346073709959088647078659064030825976089624063020015068078829995959932007036956072103006028803020951879879889949947027938479097426919076050946077956102081103906976083029021880936796080076078005991070708074399008903064086008034507016965065099078058036061092093091077906903801077000089702055077008005089500962051086106056968077958002058096068030022035961003037088960069079089049088053032089530500026081029950903061096096009079000805007098049088904001020040208908059801095507099055092005907068910060084048009096078003063050906006066055019095091002065040077019790090105006090808600100902088905502007080701020051087055500089021090209003088006070007085006094020909059052065069070";

        let currentPage = 1;
        let settings = {
            squareSize: 30,
            squaresPerPage: 100,
            colorMode: 'standard'
        };

        // Modos de color
        const colorModes = {
            standard: (digits) => {
                const str = digits.toString().padStart(3, '0');
                let r = parseInt(str[0]) * 28;
                let g = parseInt(str[1]) * 28;
                let b = parseInt(str[2]) * 28;
                return { r: Math.min(255, r), g: Math.min(255, g), b: Math.min(255, b) };
            },
            enhanced: (digits) => {
                const str = digits.toString().padStart(3, '0');
                let r = parseInt(str[0]) * 25.5 + 30;
                let g = parseInt(str[1]) * 25.5 + 30;
                let b = parseInt(str[2]) * 25.5 + 30;
                return { r: Math.min(255, r), g: Math.min(255, g), b: Math.min(255, b) };
            },
            pastel: (digits) => {
                const str = digits.toString().padStart(3, '0');
                let r = parseInt(str[0]) * 15 + 150;
                let g = parseInt(str[1]) * 15 + 150;
                let b = parseInt(str[2]) * 15 + 150;
                return { r: Math.min(255, r), g: Math.min(255, g), b: Math.min(255, b) };
            },
            vibrant: (digits) => {
                const str = digits.toString().padStart(3, '0');
                const hue = (parseInt(str) / 999) * 360;
                const saturation = 70 + (parseInt(str[1]) * 3);
                const lightness = 40 + (parseInt(str[2]) * 2);
                return hslToRgb(hue, saturation, lightness);
            }
        };

        // Convertir HSL a RGB
        function hslToRgb(h, s, l) {
            h /= 360;
            s /= 100;
            l /= 100;
            
            const c = (1 - Math.abs(2 * l - 1)) * s;
            const x = c * (1 - Math.abs((h * 6) % 2 - 1));
            const m = l - c / 2;
            
            let r, g, b;
            
            if (h < 1/6) {
                r = c; g = x; b = 0;
            } else if (h < 2/6) {
                r = x; g = c; b = 0;
            } else if (h < 3/6) {
                r = 0; g = c; b = x;
            } else if (h < 4/6) {
                r = 0; g = x; b = c;
            } else if (h < 5/6) {
                r = x; g = 0; b = c;
            } else {
                r = c; g = 0; b = x;
            }
            
            return {
                r: Math.round((r + m) * 255),
                g: Math.round((g + m) * 255),
                b: Math.round((b + m) * 255)
            };
        }

        // Calcular brillo del color
        function calculateBrightness(r, g, b) {
            return (r * 299 + g * 587 + b * 114) / 1000;
        }

        // Obtener dígitos de π
        function getPiDigits() {
            return PI_DIGITS.replace('.', '');
        }

        // Actualizar configuración
        function updateSettings() {
            settings.squareSize = parseInt(document.getElementById('squareSize').value);
            let spValue = document.getElementById('squaresPerPage').value;
            if (spValue === 'fullhd') {
                // Calcular cuántos cuadros caben en 1920x1080
                const cols = Math.floor(1920 / settings.squareSize);
                const rows = Math.floor(1080 / settings.squareSize);
                settings.squaresPerPage = cols * rows;
            } else {
                settings.squaresPerPage = parseInt(spValue);
            }
            settings.colorMode = document.getElementById('colorMode').value;
            setTimeout(() => {
                renderPage();
            }, 100);
        }

        // Renderizar página con mosaico compacto
        function renderPage() {
            const piDigits = getPiDigits();
            const startIndex = (currentPage - 1) * settings.squaresPerPage * 3;
            const endIndex = startIndex + settings.squaresPerPage * 3;
            const maxPiDigits = piDigits.length;
            // A partir de la página 23, usar aleatorio
            const usandoInfinito = currentPage >= 23;

            const gridContainer = document.getElementById('gridContainer');
            const fragment = document.createDocumentFragment();

            // **CÁLCULO MEJORADO PARA MOSAICO COMPACTO**
            // Calcular columnas basándose en el ancho disponible del contenedor
            const containerWidth = 800; // Ancho máximo disponible
            const columns = Math.floor(containerWidth / settings.squareSize);
            const gridWidth = columns * settings.squareSize;

            // Configurar el grid sin espacios
            gridContainer.style.gridTemplateColumns = `repeat(${columns}, ${settings.squareSize}px)`;
            gridContainer.style.width = `${gridWidth}px`;
            gridContainer.style.gap = '0'; // Asegurar que no hay espacios

            // Actualizar información
            document.getElementById('pageNumber').textContent = currentPage;
            if (usandoInfinito) {
                document.getElementById('digitRange').textContent = `Dígitos aleatorios generados (∞)`;
            } else {
                document.getElementById('digitRange').textContent = `Dígitos ${startIndex + 1} - ${Math.min(endIndex, maxPiDigits)} de π`;
            }

            // Mostrar dígitos actuales o aleatorios
            let currentDigits;
            if (usandoInfinito) {
                currentDigits = '';
                for (let i = 0; i < settings.squaresPerPage * 3; i++) {
                    currentDigits += Math.floor(Math.random() * 10).toString();
                }
                document.getElementById('piDisplay').textContent = '3.' + currentDigits + '...';
            } else {
                currentDigits = piDigits.substring(startIndex, endIndex);
                document.getElementById('piDisplay').textContent = '3.' + currentDigits;
            }

            // Estadísticas
            let totalBrightness = 0;
            let uniqueColors = new Set();
            let squaresCreated = 0;

            // Crear cuadros compactos
            for (let i = 0; i < settings.squaresPerPage; i++) {
                let threeDigits;
                if (usandoInfinito) {
                    threeDigits = '';
                    for (let j = 0; j < 3; j++) {
                        threeDigits += Math.floor(Math.random() * 10).toString();
                    }
                } else {
                    const digitIndex = startIndex + i * 3;
                    threeDigits = piDigits.substring(digitIndex, digitIndex + 3);
                }

                if (threeDigits.length === 3) {
                    const digits = parseInt(threeDigits);
                    const { r, g, b } = colorModes[settings.colorMode](digits);
                    const brightness = calculateBrightness(r, g, b);

                    totalBrightness += brightness;
                    uniqueColors.add(`${r},${g},${b}`);

                    const square = document.createElement('div');
                    square.className = 'color-square';
                    square.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                    square.style.width = `${settings.squareSize}px`;
                    square.style.height = `${settings.squareSize}px`;
                    // **IMPORTANTE**: Sin margin, padding, border
                    square.style.margin = '0';
                    square.style.padding = '0';
                    square.style.border = 'none';

                    const colorInfo = document.createElement('div');
                    colorInfo.className = 'color-info';
                    colorInfo.innerHTML = `
                        Dígitos: ${threeDigits}<br>
                        RGB: (${r}, ${g}, ${b})<br>
                        Brillo: ${Math.round(brightness)}
                    `;

                    square.appendChild(colorInfo);

                    // Event listener para mostrar detalles
                    (function(digits, r, g, b, brightness) {
                        square.addEventListener('click', function() {
                            showColorDetails(digits, r, g, b, brightness);
                        });
                    })(threeDigits, r, g, b, brightness);

                    fragment.appendChild(square);
                    squaresCreated++;
                }
            }

            // Limpiar y agregar elementos
            gridContainer.innerHTML = '';
            gridContainer.appendChild(fragment);

            // Actualizar estadísticas
            document.getElementById('totalDigits').textContent = usandoInfinito ? '∞' : maxPiDigits;
            document.getElementById('avgBrightness').textContent = squaresCreated > 0 ? Math.round(totalBrightness / squaresCreated) : (usandoInfinito ? '∞' : 0);
            document.getElementById('colorVariety').textContent = usandoInfinito ? '∞' : uniqueColors.size;

            // Actualizar botones
            document.getElementById('prevBtn').disabled = currentPage === 1;
            let maxPage = Math.ceil(maxPiDigits / (settings.squaresPerPage * 3));
            // Si ya estamos en infinito, nunca deshabilitar el botón siguiente
            document.getElementById('nextBtn').disabled = false;
        }

        // Mostrar detalles del color
        function showColorDetails(digits, r, g, b, brightness) {
            const details = document.getElementById('colorDetails');
            details.innerHTML = `
                <div style="width: 100px; height: 100px; background: rgb(${r}, ${g}, ${b}); margin: 10px auto; border-radius: 10px;"></div>
                <p><strong>Dígitos de π:</strong> ${digits}</p>
                <p><strong>RGB:</strong> (${r}, ${g}, ${b})</p>
                <p><strong>Hex:</strong> #${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}</p>
                <p><strong>Brillo:</strong> ${Math.round(brightness)}</p>
                <p><strong>Posición:</strong> Página ${currentPage}</p>
            `;
            
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('colorPicker').style.display = 'block';
        }

        function closeColorPicker() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('colorPicker').style.display = 'none';
        }

        // Navegación
        function nextPage() {
            // Permitir avanzar siempre si estamos en modo infinito
            if (currentPage >= 22) {
                currentPage++;
                renderPage();
            } else {
                const piDigits = getPiDigits();
                const maxPage = Math.ceil(piDigits.length / (settings.squaresPerPage * 3));
                if (currentPage < maxPage) {
                    currentPage++;
                    renderPage();
                }
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderPage();
            }
        }

        function randomPage() {
            // Si estamos en modo infinito, elegir cualquier página >= 23
            if (currentPage >= 23) {
                currentPage = Math.floor(Math.random() * 1000) + 23; // Puedes ajustar el rango si quieres más o menos páginas
                renderPage();
            } else {
                const piDigits = getPiDigits();
                const maxPage = Math.ceil(piDigits.length / (settings.squaresPerPage * 3));
                currentPage = Math.floor(Math.random() * maxPage) + 1;
                renderPage();
            }
        }

        function goToPage() {
            let page;
            if (currentPage >= 23) {
                page = prompt(`¿A qué página quieres ir? (23 o mayor, infinito)`);
                if (page && !isNaN(page) && page >= 23) {
                    currentPage = parseInt(page);
                    renderPage();
                }
            } else {
                const piDigits = getPiDigits();
                const maxPage = Math.ceil(piDigits.length / (settings.squaresPerPage * 3));
                page = prompt(`¿A qué página quieres ir? (1-${maxPage})`);
                if (page && !isNaN(page) && page > 0 && page <= maxPage) {
                    currentPage = parseInt(page);
                    renderPage();
                } else if (page && !isNaN(page) && page > maxPage) {
                    alert(`Solo hay ${maxPage} páginas disponibles`);
                }
            }
        }

        // Guardar imagen
        function saveImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const gridContainer = document.getElementById('gridContainer');
            const squares = gridContainer.querySelectorAll('.color-square');
            
            if (squares.length === 0) {
                alert('No hay colores para guardar');
                return;
            }
            
            const columns = Math.floor(800 / (settings.squareSize + 2));
            const rows = Math.ceil(squares.length / columns);
            
            canvas.width = columns * settings.squareSize;
            canvas.height = rows * settings.squareSize;
            
            // Fondo blanco
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            squares.forEach((square, index) => {
                const x = (index % columns) * settings.squareSize;
                const y = Math.floor(index / columns) * settings.squareSize;
                const color = square.style.backgroundColor;
                
                ctx.fillStyle = color;
                ctx.fillRect(x, y, settings.squareSize, settings.squareSize);
            });
            
            // Crear enlace de descarga
            const link = document.createElement('a');
            link.download = `pi-colors-page-${currentPage}.png`;
            link.href = canvas.toDataURL();
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event listeners
        document.getElementById('squareSize').addEventListener('change', updateSettings);
        document.getElementById('squaresPerPage').addEventListener('change', updateSettings);
        document.getElementById('colorMode').addEventListener('change', updateSettings);
        document.getElementById('overlay').addEventListener('click', closeColorPicker);

        // Navegación con teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                previousPage();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextPage();
            } else if (e.key === ' ') {
                e.preventDefault();
                randomPage();
            } else if (e.key === 'Escape') {
                closeColorPicker();
            }
        });

        // Preloader para mejorar experiencia
        function showLoading() {
            const gridContainer = document.getElementById('gridContainer');
            gridContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Cargando colores...</div>';
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar carga inicial
            showLoading();
            
            // Renderizar primera página después de un breve delay
            setTimeout(() => {
                renderPage();
            }, 100);
        });

        // Manejar cambio de tamaño de ventana
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                renderPage();
            }, 300);
        });
    </script>
</body>
</html>